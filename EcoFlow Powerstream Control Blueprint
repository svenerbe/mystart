blueprint:
  name: EcoFlow Powerstream Control
  description: "Automatically adjusts power stream settings on EcoFlow device based on SDM630 Total Power and battery charge status."
  domain: automation
  input:
    power_sensor:
      name: SDM630 Total Power Sensor
      description: "Select the sensor that measures the total power consumption."
      selector:
        entity:
          domain: sensor
    powerstream_automation_switch:
      name: Powerstream Automation Switch
      description: "Select the switch that controls the automation of powerstream."
      selector:
        entity:
          domain: switch
    battery_charge_sensor:
      name: Battery Charge Sensor
      description: "Select the sensor that measures the battery charge status."
      selector:
        entity:
          domain: sensor
    serial_number:
      name: EcoFlow Device Serial Number
      description: "Enter the Serial Number of your EcoFlow device."
      default: "Your Serial Number"
      selector:
        text:
  source_url: "https://github.com/YOUR_GITHUB_USERNAME/YOUR_REPO_NAME/blob/main/ecoflow_powerstream_control.yaml"
trigger:
  platform: state
  entity_id: !input 'power_sensor'
action:
  - variables:
      powerstream_automation: !input 'powerstream_automation_switch'
      battery_charge: !input 'battery_charge_sensor'
      serial_number: !input 'serial_number'
  - choose:
      - conditions:
          - condition: state
            entity_id: !input 'powerstream_automation_switch'
            state: "on"
          - condition: numeric_state
            entity_id: !input 'battery_charge_sensor'
            above: 0
        sequence:
          - service: pyscript.set_ef_powerstream_custom_load_power
            data:
              SerialNumber: !input 'serial_number'
              TotalPower: "{{ states(input.power_sensor) | round }}"
              Automation: true
      - conditions:
          - condition: state
            entity_id: !input 'powerstream_automation_switch'
            state: "on"
          - condition: numeric_state
            entity_id: !input 'battery_charge_sensor'
            below: 1
        sequence:
          - service: pyscript.set_ef_powerstream_custom_load_power
            data:
              SerialNumber: !input 'serial_number'
              TotalPower: 0
              Automation: false
      - conditions:
          - condition: state
            entity_id: !input 'powerstream_automation_switch'
            state: "off"
        sequence:
          - service: pyscript.set_ef_powerstream_custom_load_power
            data:
              SerialNumber: !input 'serial_number'
              TotalPower: 0
              Automation: false
mode: single

